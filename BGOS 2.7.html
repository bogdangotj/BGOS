<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>BGOS</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Consolas&display=swap');
  body, html {
    margin: 0; padding: 0; height: 100%;
    font-family: Consolas, monospace, 'Courier New', monospace;
    color: #d4d4d4;
    background-color: #1e1e1e;
    transition: background-color 0.3s, color 0.3s;
  }
  body.light {
    background-color: #f5f5f5;
    color: #222;
  }
  #loader-box {
    position: fixed;
    z-index: 9999;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    border: 5px solid black;
    width: 90vw;
    max-width: 420px;
    background: #fff;
    padding: 3vw 4vw 4vw 4vw;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    user-select: none;
    border-radius: 6px;
  }
  #title {
    font-size: 10vw;
    max-font-size: 72px;
    font-weight: 900;
    color: black;
    display: flex;
    justify-content: flex-start;
    align-items: baseline;
    line-height: 1;
  }
  #title span.version {
    font-size: 3.2vw;
    max-font-size: 20px;
    font-weight: 400;
    margin-left: auto;
  }
  #progress-bar {
    width: 100%;
    height: 1.7vw;
    max-height: 8px;
    background: #222;
    border-radius: 4px;
    overflow: hidden;
    margin-top: 4vw;
  }
  #progress-fill {
    background: #35b843;
    height: 100%;
    width: 0%;
    transition: width 0.1s linear;
  }
  #random-text {
    font-size: 4vw;
    max-font-size: 18px;
    margin-top: 1.5vw;
    color: black;
    text-align: center;
  }
  #loading-text {
    font-size: 12vw;
    max-font-size: 72px;
    margin-top: 3vw;
    font-weight: 700;
    color: black;
    text-align: center;
  }
  @media screen and (min-width: 500px) {
    #loader-box {
      padding: 20px 30px 30px 30px;
    }
    #title {
      font-size: 72px;
    }
    #title span.version {
      font-size: 20px;
    }
    #progress-bar {
      height: 8px;
      margin-top: 20px;
    }
    #random-text {
      font-size: 18px;
      margin-top: 8px;
    }
    #loading-text {
      font-size: 72px;
      margin-top: 14px;
    }
  }
  #container {
    display: none;
    flex-direction: column;
    flex-grow: 1;
    position: relative;
    max-width: 800px;
    margin: 20px auto;
    box-shadow: 0 0 12px rgba(0,0,0,0.8);
    border-radius: 6px;
    background: #252526;
    height: 90vh;
    overflow: hidden;
    user-select: none;
    transition: background-color 0.3s;
  }
  body.light #container {
    background: #fff;
    box-shadow: 0 0 15px rgba(0,0,0,0.1);
  }
  #header {
    height: 38px;
    background: linear-gradient(90deg, #0078d7, #005a9e);
    color: white;
    font-weight: 600;
    user-select: text;
    display: flex;
    align-items: center;
    padding: 0 15px;
    border-top-left-radius: 6px;
    border-top-right-radius: 6px;
    font-size: 16px;
    position: relative;
  }
  #btn-load-json, #btn-export, #btn-theme {
    position: absolute;
    top: 6px;
    width: 28px;
    height: 28px;
    background-color: #0078d7;
    border: none;
    border-radius: 5px;
    font-size: 20px;
    line-height: 24px;
    color: white;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    display: flex;
    justify-content: center;
    align-items: center;
    transition: background-color 0.2s ease;
  }
  #btn-load-json:hover, #btn-export:hover, #btn-theme:hover {
    background-color: #005a9e;
  }
  #btn-load-json { right: 12px; }
  #btn-export { right: 50px; }
  #btn-theme { right: 88px; }
  #terminal {
    flex-grow: 1;
    padding: 15px 20px;
    background: #1e1e1e;
    overflow-y: auto;
    white-space: pre-wrap;
    font-size: 14px;
    border-bottom: 1px solid #333;
    user-select: text;
    transition: background-color 0.3s, color 0.3s;
  }
  body.light #terminal {
    background: #fafafa;
    color: #111;
    border-color: #ddd;
  }
  #input-section {
    display: flex;
    padding: 10px 20px;
    background: #252526;
    border-bottom-left-radius: 6px;
    border-bottom-right-radius: 6px;
    transition: background-color 0.3s;
  }
  body.light #input-section {
    background: #fff;
  }
  #command-input {
    flex-grow: 1;
    background: #1e1e1e;
    border: 1px solid #555;
    border-radius: 4px;
    padding: 9px 12px;
    font-size: 16px;
    font-family: Consolas, monospace;
    color: #eee;
    outline: none;
    transition: border-color 0.2s ease, background-color 0.3s, color 0.3s;
  }
  body.light #command-input {
    background: #fff;
    color: #222;
    border-color: #ccc;
  }
  #command-input:focus {
    border-color: #0078d7;
    background: #252526;
  }
  body.light #command-input:focus {
    background: #eaeaea;
  }
  #btn-send {
    margin-left: 10px;
    background-color: #0078d7;
    border: none;
    border-radius: 4px;
    color: white;
    font-family: Consolas, monospace;
    font-weight: 600;
    font-size: 16px;
    padding: 10px 18px;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    transition: background-color 0.2s ease;
  }
  #btn-send:hover {
    background-color: #005a9e;
  }
  #error-screen {
  display: none;
  position: fixed;
  top: 0; 
  left: 0;
  width: 100vw;
  height: 100vh;
  background: #0033cc;
  color: #fff;
  z-index: 9999;
  padding: 20px;
  font-family: monospace;
  box-sizing: border-box;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}

#error-screen h1 {
  margin-top: 0;
  font-size: 2em;
  font-weight: bold;
}

#error-info {
  white-space: pre-wrap;
  word-break: break-word;
  margin-top: 1em;
  font-size: 1em;
  max-width: 100%;
}

</style>
</head>
<body>
<div id="error-screen" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:#0033cc;color:#fff;z-index:9999;padding:20px;font-family:monospace;">
  <h1>BGOS ERROR</h1>
  <p>Attention, a small error has occurred, please contact the developers for help</p>
  <pre id="error-info"></pre>
</div>

<div id="loader-box" role="region" aria-label="–ó–∞–≥—Ä—É–∑–∫–∞ BGOS">
  <div id="title">BGOS<span class="version">v. 2.7</span></div>
  <div id="progress-bar" aria-label="–ü—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏">
    <div id="progress-fill"></div>
  </div>
  <div id="random-text" aria-live="polite" aria-atomic="true">{—Ç–µ–∫—Å—Ç}</div>
  <div id="loading-text" aria-label="–ó–∞–≥—Ä—É–∑–∫–∞">–∑–∞–≥—Ä—É–∑–∫–∞...</div>
</div>

<div id="container" role="main" aria-label="–¢–µ—Ä–º–∏–Ω–∞–ª BGOS 2.7" tabindex="0">
  <div id="header">
    BGOS –¢–µ—Ä–º–∏–Ω–∞–ª 
    <button id="btn-theme" title="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É" aria-label="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">üåì</button>
    <button id="btn-export" title="–≠–∫—Å–ø–æ—Ä—Ç –∫–æ–º–∞–Ω–¥ –∏ –∏—Å—Ç–æ—Ä–∏–∏" aria-label="–≠–∫—Å–ø–æ—Ä—Ç –∫–æ–º–∞–Ω–¥ –∏ –∏—Å—Ç–æ—Ä–∏–∏">‚á©</button>
    <button id="btn-load-json" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å JSON –∫–æ–º–∞–Ω–¥—É" aria-label="–ó–∞–≥—Ä—É–∑–∏—Ç—å JSON –∫–æ–º–∞–Ω–¥—É">+</button>
  </div>
  <div id="terminal" aria-live="polite" aria-atomic="false"></div>
  <div id="input-section">
    <input id="command-input" type="text" autocomplete="off" aria-label="–°—Ç—Ä–æ–∫–∞ –≤–≤–æ–¥–∞ –∫–æ–º–∞–Ω–¥—ã" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É...">
    <button id="btn-send" aria-label="–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É">–í–≤–æ–¥</button>
  </div>
  <input type="file" id="file-input" accept="application/json" style="display:none" aria-hidden="true" />
</div>

<script>
window.onerror = function(message, url, line, col, error) {
  const screen = document.getElementById('error-screen');
  const info = document.getElementById('error-info');
  if (!screen || !info) {
    console.error('–û—à–∏–±–∫–∞:', message, url, line, col, error);
    return true;
  }
  let details = `–°–æ–æ–±—â–µ–Ω–∏–µ: ${message}\n`;
  if (url) details += `URL: ${url}\n`;
  if (line !== undefined) details += `–°—Ç—Ä–æ–∫–∞: ${line}\n`;
  if (col !== undefined) details += `–°—Ç–æ–ª–±–µ—Ü: ${col}\n`;
  if (error && error.stack) details += `–°—Ç–µ–∫ –≤—ã–∑–æ–≤–æ–≤:\n${error.stack}`;
  else if (error) details += `Error: ${error.toString()}`;
  info.textContent = details;
  screen.style.display = 'block';
  screen.focus();
  document.getElementById('loader-box').style.display = 'none';
  document.getElementById('container').style.display = 'none';
  return true;
};

window.onunhandledrejection = function(event) {
  const screen = document.getElementById('error-screen');
  const info = document.getElementById('error-info');
  if (!screen || !info) {
    console.error('Unhandled Promise Rejection:', event.reason);
    return;
  }
  let details = '–ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ Promise:\n';
  if (event.reason && event.reason.message) details += event.reason.message + '\n';
  if (event.reason && event.reason.stack) details += event.reason.stack;
  else details += (event.reason ? event.reason.toString() : 'No details');
  info.textContent = details;
  screen.style.display = 'block';
  screen.focus();
  document.getElementById('loader-box').style.display = 'none';
  document.getElementById('container').style.display = 'none';
};

const defaultTexts = [
  "–ú–∞—Ä–∞—Ä", "–ë–æ–ª—å—à–µ –≤–µ—Å–µ–ª—å—è!", "–ú–∞–π–Ω–∫—Ä–∞—Ñ—Ç", "–¢–µ—Ä–º–∏–Ω–∞–ª",
  "/test", "/help", "/clear", "–¢—ã —á–∏—Ç–∞–µ—à—å —ç—Ç–æ?",
  "–ë–û–õ–¨–®–ï –¢–ï–ö–°–¢!", "error", "unknown error"
];

let cmtext = [...defaultTexts];
let useDefaultTexts = true;

const randomTextEl = document.getElementById('random-text');

function updateLoadingText() {
  if (cmtext.length === 0) {
    randomTextEl.textContent = '';
    return;
  }
  const idx = Math.floor(Math.random() * cmtext.length);
  randomTextEl.textContent = cmtext[idx];
}

let loadingTextInterval = setInterval(updateLoadingText, 1500);

const progressFill = document.getElementById('progress-fill');
const loaderBox = document.getElementById('loader-box');
const container = document.getElementById('container');
const totalDuration = 5000;
const targetPercent = 85;
let startTime = null;
let loadingComplete = false;

function setLoadingVisible(isVisible) {
  if (isVisible) {
    loaderBox.style.display = 'flex';
    container.style.display = 'none';
    document.getElementById('error-screen').style.display = 'none';
  } else {
    loaderBox.style.display = 'none';
    container.style.display = 'flex';
  }
}

function animateProgress(timestamp) {
  if (!startTime) startTime = timestamp;
  let elapsed = timestamp - startTime;
  let progress = Math.min(elapsed / totalDuration, 1);
  progressFill.style.width = (progress * targetPercent) + '%';
  if (elapsed < totalDuration) {
    requestAnimationFrame(animateProgress);
  } else {
    setLoadingVisible(false);
    loadingComplete = true;
    document.getElementById('command-input').focus();
  }
}

const terminal = document.getElementById('terminal');
const input = document.getElementById('command-input');
const btnSend = document.getElementById('btn-send');
const btnLoadJson = document.getElementById('btn-load-json');
const btnExport = document.getElementById('btn-export');
const btnTheme = document.getElementById('btn-theme');
const fileInput = document.getElementById('file-input');
const body = document.body;

const baseCommands = {
  '/help': {
    description: '–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∫–æ–º–∞–Ω–¥ –∏–ª–∏ –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–º–∞–Ω–¥–µ',
    example: '/help /test',
    syntax: '/help [–∫–æ–º–∞–Ω–¥–∞]',
    execute: (args) => {
      if (args.length === 0) {
        let keys = Object.keys(commands).sort();
        return '–ö–æ–º–∞–Ω–¥—ã:<br>' + keys.join(', ');
      } else {
        let cmd = args[0].toLowerCase();
        if (!(cmd in commands)) {
          return `–ö–æ–º–∞–Ω–¥–∞ "${cmd}" –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.`;
        }
        let c = commands[cmd];
        return `<b>–ö–æ–º–∞–Ω–¥–∞:</b> ${cmd}<br>` +
               `<b>–û–ø–∏—Å–∞–Ω–∏–µ:</b> ${c.description || '–Ω–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}<br>` +
               `<b>–ü—Ä–∏–º–µ—Ä:</b> ${c.example || '–Ω–µ—Ç –ø—Ä–∏–º–µ—Ä–∞'}<br>` +
               `<b>–°–∏–Ω—Ç–∞–∫—Å–∏—Å:</b> ${c.syntax || '–Ω–µ—Ç —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞'}`;
      }
    }
  },
  '/test': {
    description: '–¢–µ—Å—Ç –∫–æ–º–∞–Ω–¥—ã BGOS',
    example: '/test',
    syntax: '/test',
    execute: () => {
      let list = Object.keys(commands).sort().join('", "');
      return `___Test BGOS___<br>1.Command list: "${list}"<br>___Test end___<br>_______________`;
    }
  },
  '/clear': {
    description: '–û—á–∏—Å—Ç–∏—Ç—å —Ç–µ—Ä–º–∏–Ω–∞–ª',
    example: '/clear',
    syntax: '/clear',
    execute: () => {
      terminal.innerHTML = '';
      return '';
    }
  },
  '/deletetext': {
    description: '–£–¥–∞–ª–∏—Ç—å —Å–ª–æ–≤–æ –∏–∑ —Ç–µ–∫—Å—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏, off ‚Äî –æ—Ç–∫–ª—é—á–∏—Ç—å –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ, –ø—É—Å—Ç–æ ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫',
    example: '/deletetext error',
    syntax: '/deletetext [—Å–ª–æ–≤–æ|off|]',
    execute: (args) => {
      if (args.length === 0) {
        if (cmtext.length === 0) {
          if (useDefaultTexts) {
            return '–¢–µ–∫—Å—Ç—ã –∑–∞–≥—Ä—É–∑–∫–∏: (–≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã –æ—Ç–∫–ª—é—á–µ–Ω—ã, —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç)';
          }
          return '–¢–µ–∫—Å—Ç—ã –∑–∞–≥—Ä—É–∑–∫–∏: —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç.';
        }
        return '–¢–µ–∫—Å—Ç—ã –∑–∞–≥—Ä—É–∑–∫–∏:\n' + cmtext.join(', ');
      }
      let arg = args[0].toLowerCase();
      if (arg === 'off') {
        useDefaultTexts = false;
        cmtext = [];
        saveState();
        updateLoadingText();
        clearInterval(loadingTextInterval);
        loadingTextInterval = setInterval(updateLoadingText, 1500);
        return '–í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ —Å–ª–æ–≤–∞ –æ—Ç–∫–ª—é—á–µ–Ω—ã.';
      }
      if (useDefaultTexts && cmtext.length === 0) cmtext = [...defaultTexts];
      let beforeLength = cmtext.length;
      cmtext = cmtext.filter(t => t.toLowerCase() !== arg);
      saveState();
      if (cmtext.length < beforeLength) {
        updateLoadingText();
        return `–°–ª–æ–≤–æ "${arg}" —É–¥–∞–ª–µ–Ω–æ –∏–∑ –∑–∞–≥—Ä—É–∑–æ—á–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤.`;
      } else {
        return `–°–ª–æ–≤–æ "${arg}" –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –∑–∞–≥—Ä—É–∑–æ—á–Ω—ã—Ö —Ç–µ–∫—Å—Ç–∞—Ö.`;
      }
    }
  }
};

let commands = {...baseCommands};
window.commands = commands;

// –û–±—ä–µ–¥–∏–Ω—ë–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–≤–æ–¥–∞ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª [–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è]
function printToTerminal(text) {
  if (!text) return;
  const html = text.replace(/\n/g, '<br>');
  terminal.innerHTML += html + '<br>';
  terminal.scrollTop = terminal.scrollHeight;
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –∫–æ–º–∞–Ω–¥
function saveCommands() {
  let custom = {};
  for (let k in commands) {
    if (!(k in baseCommands)) {
      const c = commands[k];
      custom[k] = {
        description: c.description,
        example: c.example,
        syntax: c.syntax,
        error: c.error || '',
        code: c._codeString || ''
      };
    }
  }
  localStorage.setItem('bgos_commands', JSON.stringify(custom));
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –∫–æ–º–∞–Ω–¥
function loadCommands() {
  let saved = localStorage.getItem('bgos_commands');
  if (saved) {
    try {
      let parsed = JSON.parse(saved);
      for (let key in parsed) {
        let c = parsed[key];
        commands[key] = {
          description: c.description,
          example: c.example,
          syntax: c.syntax,
          error: c.error || '',
          execute: (args) => {
            if (c.syntax && args.length === 0) {
              return c.error || ('–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ' + c.syntax);
            }
            try {
              let func = new Function('args', c.code);
              return func(args);
            } catch (err) {
              return `–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã: ${err.message}`;
            }
          },
          _codeString: c.code
        };
      }
      window.commands = commands;
    } catch (e) {
      printToTerminal('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –∫–æ–º–∞–Ω–¥: ' + e.message);
    }
  }
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Å–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è: –∫–æ–º–∞–Ω–¥ + –∑–∞–≥—Ä—É–∑–æ—á–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤
function saveState() {
  saveCommands();
  localStorage.setItem('bgos_cmtexts', JSON.stringify({
    texts: cmtext,
    useDefaultTexts: useDefaultTexts
  }));
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
function loadState() {
  loadCommands();
  let saved = localStorage.getItem('bgos_cmtexts');
  if (saved) {
    try {
      let obj = JSON.parse(saved);
      if (obj.texts && Array.isArray(obj.texts)) {
        cmtext = obj.texts;
      }
      if (typeof obj.useDefaultTexts === 'boolean') {
        useDefaultTexts = obj.useDefaultTexts;
      }
      updateLoadingText();
    } catch (e) {
      printToTerminal('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤: ' + e.message);
    }
  }
}

// –ó–∞–ø—É—Å–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö cmglobal –ø–∞—Ç—á–µ–π –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
(function loadCmglobalPatches() {
  try {
    let storeJson = localStorage.getItem('bgos_cmglobal_store');
    if (storeJson) {
      let store = JSON.parse(storeJson);
      for (let name in store) {
        try {
          new Function(store[name])();
          printToTerminal(`–ü—Ä–∏–º–µ–Ω—ë–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π cmglobal –ø–∞—Ç—á: ${name}`);
        } catch (e) {
          printToTerminal(`–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è cmglobal –ø–∞—Ç—á–∞ ${name}: ${e.message}`);
        }
      }
    }
  } catch (e) {
    printToTerminal('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ cmglobal –ø–∞—Ç—á–µ–π: ' + e.message);
  }
})();

// –ó–∞–ø—É—Å–∫ –∫–æ–º–∞–Ω–¥
async function runCommand(cmdLine) {
  if (!cmdLine.trim()) return;
  printToTerminal('> ' + cmdLine);
  let parts = cmdLine.split(' ');
  let cmd = parts[0];
  let args = parts.slice(1);
  if (!(cmd in commands)) {
    printToTerminal(`–û—à–∏–±–∫–∞: –∫–æ–º–∞–Ω–¥–∞ "${cmd}" –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –î–ª—è —Å–ø–∏—Å–∫–∞ –∫–æ–º–∞–Ω–¥ –≤–≤–µ–¥–∏—Ç–µ /help`);
    return;
  }
  let command = commands[cmd];
  try {
    let output = command.execute(args);
    if (output instanceof Promise) {
      output = await output;
    }
    printToTerminal(output);
  } catch (e) {
    printToTerminal(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∫–æ–º–∞–Ω–¥—ã "${cmd}": ${e.message}`);
  }
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–∞–Ω–¥—ã
btnSend.onclick = async () => {
  await runCommand(input.value);
  input.value = '';
  input.focus();
};

// –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
input.addEventListener('keydown', async e => {
  if (e.key === 'Enter') {
    await runCommand(input.value);
    input.value = '';
    e.preventDefault();
  }
});

// –ö–Ω–æ–ø–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ JSON - –∑–∞–ø—É—Å–∫ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞
btnLoadJson.onclick = () => {
  fileInput.value = null;
  fileInput.click();
};

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ JSON-—Ñ–∞–π–ª–∞ —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π cmglobal
fileInput.onchange = e => {
  let file = e.target.files[0];
  if (!file) return;
  let reader = new FileReader();
  reader.onload = evt => {
    try {
      let data = JSON.parse(evt.target.result);
      if (!data.type) {
        printToTerminal('–û—à–∏–±–∫–∞: –≤ JSON –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–∫–∞–∑–∞–Ω —Ç–∏–ø: cmtext, cmdata, cmpack, cmsolo –∏–ª–∏ cmglobal');
        return;
      }
      if (data.type === 'cmtext' || data.type === 'cmdata') {
        if (Array.isArray(data.texts)) {
          cmtext = data.texts;
          useDefaultTexts = false;
          saveState();
          updateLoadingText();
          clearInterval(loadingTextInterval);
          loadingTextInterval = setInterval(updateLoadingText, 1500);
          printToTerminal(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${cmtext.length} —Ç–µ–∫—Å—Ç–æ–≤ —Ñ–æ—Ä–º–∞—Ç–∞ ${data.type}.`);
        } else {
          printToTerminal('–û—à–∏–±–∫–∞: –≤ —Ñ–æ—Ä–º–∞—Ç–µ ' + data.type + ' –ø–æ–ª–µ texts –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º.');
        }
        if (data.commands && typeof data.commands === 'object' && data.type === 'cmdata') {
          let added = 0, updated = 0;
          for (let key in data.commands) {
            let c = data.commands[key];
            if (!c.description || !c.example || !c.syntax || !c.error || !c.code) {
              printToTerminal(`–ü—Ä–æ–ø—É—â–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ ${key} –∏–∑-–∑–∞ –Ω–µ–ø–æ–ª–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö`);
              continue;
            }
            if(commands.hasOwnProperty(key)) updated++; else added++;
            commands[key] = {
              description: c.description,
              example: c.example,
              syntax: c.syntax,
              error: c.error,
              execute: (args) => {
                if(c.syntax && args.length === 0) {
                  return c.error;
                }
                try {
                  let func = new Function('args', c.code);
                  return func(args);
                } catch(err) {
                  return `–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã: ${err.message}`;
                }
              },
              _codeString: c.code
            };
          }
          saveState();
          window.commands = commands;
          printToTerminal(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∫–æ–º–∞–Ω–¥: ${added}, –æ–±–Ω–æ–≤–ª–µ–Ω–æ –∫–æ–º–∞–Ω–¥: ${updated}`);
        }
      } else if (data.type === 'cmpack') {
        if (!data.commands || typeof data.commands !== 'object') {
          printToTerminal('–û—à–∏–±–∫–∞: cmpack –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –æ–±—ä–µ–∫—Ç commands');
          return;
        }
        let added = 0, updated = 0;
        for (let key in data.commands) {
          let c = data.commands[key];
          if (!c.description || !c.example || !c.syntax || !c.error || !c.code) {
            printToTerminal(`–ü—Ä–æ–ø—É—â–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ ${key} –∏–∑-–∑–∞ –Ω–µ–ø–æ–ª–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö`);
            continue;
          }
          if(commands.hasOwnProperty(key)) updated++; else added++;
          commands[key] = {
            description: c.description,
            example: c.example,
            syntax: c.syntax,
            error: c.error,
            execute: (args) => {
              if(c.syntax && args.length === 0) {
                return c.error;
              }
              try {
                let func = new Function('args', c.code);
                return func(args);
              } catch(err) {
                return `–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã: ${err.message}`;
              }
            },
            _codeString: c.code
          };
        }
        saveState();
        window.commands = commands;
        printToTerminal(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∫–æ–º–∞–Ω–¥: ${added}, –æ–±–Ω–æ–≤–ª–µ–Ω–æ –∫–æ–º–∞–Ω–¥: ${updated}`);
      } else if (data.type === 'cmsolo') {
        if (!data.command || !data.description || !data.example || !data.syntax || !data.error || !data.code) {
          printToTerminal('–û—à–∏–±–∫–∞: cmsolo –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –≤—Å–µ –ø–æ–ª—è –∫–æ–º–∞–Ω–¥—ã');
          return;
        }
        let isUpdate = commands.hasOwnProperty(data.command);
        commands[data.command] = {
          description: data.description,
          example: data.example,
          syntax: data.syntax,
          error: data.error,
          execute: (args) => {
            if(data.syntax && args.length === 0) {
              return data.error;
            }
            try {
              let func = new Function('args', data.code);
              return func(args);
            } catch(err) {
              return `–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã: ${err.message}`;
            }
          },
          _codeString: data.code
        };
        saveState();
        window.commands = commands;
        printToTerminal((isUpdate ? '–û–±–Ω–æ–≤–ª–µ–Ω–∞' : '–î–æ–±–∞–≤–ª–µ–Ω–∞') + ` –∫–æ–º–∞–Ω–¥–∞ ${data.command}.`);
      } else if (data.type === 'cmglobal') {
        if (!data.code || !data.name) {
          printToTerminal('–û—à–∏–±–∫–∞: –≤ —Ñ–æ—Ä–º–∞—Ç–µ cmglobal –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã –ø–æ–ª—è name –∏ code');
          return;
        }
        try {
          let storeJson = localStorage.getItem('bgos_cmglobal_store');
          let store = storeJson ? JSON.parse(storeJson) : {};
          store[data.name] = data.code;
          localStorage.setItem('bgos_cmglobal_store', JSON.stringify(store));
          let func = new Function(data.code);
          func();
          printToTerminal(`–í—ã–ø–æ–ª–Ω–µ–Ω –∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω cmglobal –ø–∞—Ç—á: ${data.name}`);
        } catch (err) {
          printToTerminal('–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è cmglobal: ' + err.message);
        }
      } else {
        printToTerminal(`–û—à–∏–±–∫–∞: –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø ${data.type}`);
      }
    } catch (err) {
      printToTerminal('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON: ' + err.message);
    }
  };
  reader.readAsText(file);
};

commands['/delcmglobal'] = {
  description: '–£–¥–∞–ª–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π cmglobal –ø–∞—Ç—á –ø–æ –∏–º–µ–Ω–∏',
  example: '/delcmglobal myPatch',
  syntax: '/delcmglobal <name>',
  error: '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /delcmglobal <name>',
  execute: (args) => {
    if (args.length === 0) return '–û—à–∏–±–∫–∞: —É–∫–∞–∂–∏—Ç–µ –∏–º—è –ø–∞—Ç—á–∞';
    let name = args[0];
    let storeJson = localStorage.getItem('bgos_cmglobal_store');
    if (!storeJson) return `–ü–∞—Ç—á —Å –∏–º–µ–Ω–µ–º "${name}" –Ω–µ –Ω–∞–π–¥–µ–Ω`;
    let store = JSON.parse(storeJson);
    if (!(name in store)) return `–ü–∞—Ç—á —Å –∏–º–µ–Ω–µ–º "${name}" –Ω–µ –Ω–∞–π–¥–µ–Ω`;
    delete store[name];
    localStorage.setItem('bgos_cmglobal_store', JSON.stringify(store));
    return `–ü–∞—Ç—á "${name}" —É–¥–∞–ª—ë–Ω –∏ –Ω–µ –±—É–¥–µ—Ç –ø—Ä–∏–º–µ–Ω—è—Ç—å—Å—è –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—É—Å–∫–µ`;
  }
};

loadState();
input.focus();
printToTerminal('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ BGOS 2.7! –í–≤–µ–¥–∏—Ç–µ /help –¥–ª—è —Å–ø–∏—Å–∫–∞ –∫–æ–º–∞–Ω–¥.');
requestAnimationFrame(animateProgress);

</script>
</body>
</html>